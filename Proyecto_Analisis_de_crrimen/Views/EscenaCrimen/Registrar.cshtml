@model Proyecto_Analisis_de_crimen.Models.EscenaCrimen

@{
    ViewBag.Title = "Registrar Escena";
}

<div class="form-container">
    <div class="form-header">
        <h2>REGISTRAR NUEVA ESCENA DEL CRIMEN</h2>
    </div>

    <form asp-action="Registrar" asp-controller="EscenaCrimen" method="post" class="form-horizontal">
        <div class="form-body">
            @if (TempData["Error"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <strong>Error!</strong> @TempData["Error"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            <div asp-validation-summary="All" class="text-danger alert alert-danger"></div>

            <div class="form-group">
                <label asp-for="FechaCrimen" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <input asp-for="FechaCrimen" type="datetime-local" class="form-control" />
                    <span asp-validation-for="FechaCrimen" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="Ubicacion" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <input asp-for="Ubicacion" class="form-control" placeholder="Calle, Número, Ciudad, Provincia" />
                    <span asp-validation-for="Ubicacion" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="TipoCrimenId" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <select asp-for="TipoCrimenId" class="form-control" asp-items="ViewBag.TiposCrimen">
                        <option value="">--- Seleccionar Tipo de Crimen ---</option>
                    </select>
                    <span asp-validation-for="TipoCrimenId" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="AreaGeografica" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <select asp-for="AreaGeografica" class="form-control" asp-items="Html.GetEnumSelectList<Proyecto_Analisis_de_crimen.Models.AreaGeografica>()">
                        <option value="">--- Seleccionar ---</option>
                    </select>
                    <span asp-validation-for="AreaGeografica" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="ModusOperandiId" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <select asp-for="ModusOperandiId" class="form-control" asp-items="ViewBag.ModusOperandi">
                        <option value="">--- Seleccionar Modus Operandi ---</option>
                    </select>
                    <span asp-validation-for="ModusOperandiId" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="HorarioCrimen" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <select asp-for="HorarioCrimen" class="form-control" asp-items="Html.GetEnumSelectList<Proyecto_Analisis_de_crimen.Models.HorarioCrimen>()">
                        <option value="">--- Seleccionar ---</option>
                    </select>
                    <span asp-validation-for="HorarioCrimen" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-3">Evidencias Encontradas</label>
                <div class="col-md-9">
                    <div id="evidencias-container">
                        @{
                            var evidenciasList = new Dictionary<string, string>
                            {
                                { "VidrioRoto", "Vidrio Roto" },
                                { "HuellasDactilares", "Huellas Dactilares" },
                                { "Sangre", "Sangre" },
                                { "Cabellos", "Cabellos" },
                                { "Fibras", "Fibras" },
                                { "ArmaFuego", "Arma de Fuego" }
                            };
                        }
                        @{
                            int evidenciaIndex = 0;
                        }
                        @foreach (var evidencia in Enum.GetValues(typeof(Proyecto_Analisis_de_crimen.Models.TipoEvidencia)))
                        {
                            var evidenciaStr = evidencia.ToString();
                            var displayName = evidenciasList.ContainsKey(evidenciaStr) ? evidenciasList[evidenciaStr] : evidenciaStr;
                            var evidenciaId = $"evidencia_{evidencia}";
                            <div class="evidencia-item mb-3 p-3 border rounded">
                                <div class="checkbox-wrapper mb-2">
                                    <!-- From Uiverse.io by Nawsome -->
                                    <div class="content">
                                        <label class="checkBox">
                                            <input class="evidencia-checkbox" type="checkbox" 
                                                   name="evidencias" value="@evidencia" 
                                                   id="@evidenciaId" 
                                                   data-evidencia="@evidencia"
                                                   data-index="@evidenciaIndex" />
                                            <div class="transition"></div>
                                        </label>
                                    </div>
                                    <label class="checkbox-label-text fw-bold" for="@evidenciaId">
                                        @displayName
                                    </label>
                                </div>
                                <div class="evidencia-descripcion" style="display: none;">
                                    <label class="form-label small">Descripción (opcional):</label>
                                    <input type="text" 
                                           class="form-control form-control-sm evidencia-desc-input" 
                                           name="evidenciasDescripciones" 
                                           placeholder="Detalle de la evidencia..."
                                           data-evidencia="@evidencia"
                                           data-index="@evidenciaIndex" />
                                </div>
                            </div>
                            evidenciaIndex++;
                        }
                    </div>
                    <small class="form-text text-muted">Seleccione las evidencias encontradas y opcionalmente agregue una descripción</small>
                </div>
            </div>

            <div class="form-group">
                <label class="control-label col-md-3">Características Especiales</label>
                <div class="col-md-9">
                    <div class="checkbox-grid">
                        <div class="checkbox-wrapper">
                            <!-- From Uiverse.io by Nawsome -->
                            <div class="content">
                                <label class="checkBox">
                                    <input asp-for="UsoViolencia" type="checkbox" />
                                    <div class="transition"></div>
                                </label>
                            </div>
                            <label class="checkbox-label-text" for="UsoViolencia">
                                Uso de Violencia
                            </label>
                        </div>
                        <div class="checkbox-wrapper">
                            <!-- From Uiverse.io by Nawsome -->
                            <div class="content">
                                <label class="checkBox">
                                    <input asp-for="ActoPlanificado" type="checkbox" />
                                    <div class="transition"></div>
                                </label>
                            </div>
                            <label class="checkbox-label-text" for="ActoPlanificado">
                                Acto Planificado
                            </label>
                        </div>
                        <div class="checkbox-wrapper">
                            <!-- From Uiverse.io by Nawsome -->
                            <div class="content">
                                <label class="checkBox">
                                    <input asp-for="MultiplesPerpetadores" type="checkbox" />
                                    <div class="transition"></div>
                                </label>
                            </div>
                            <label class="checkbox-label-text" for="MultiplesPerpetadores">
                                Múltiples Perpetradores
                            </label>
                        </div>
                        <div class="checkbox-wrapper">
                            <!-- From Uiverse.io by Nawsome -->
                            <div class="content">
                                <label class="checkBox">
                                    <input asp-for="AutoriaDesconocida" type="checkbox" />
                                    <div class="transition"></div>
                                </label>
                            </div>
                            <label class="checkbox-label-text" for="AutoriaDesconocida">
                                Autoría Desconocida
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label asp-for="DescripcionDetallada" class="control-label col-md-3"></label>
                <div class="col-md-9">
                    <textarea asp-for="DescripcionDetallada" class="form-control" rows="5" placeholder="Detalle la situación, circunstancias y hallazgos iniciales..."></textarea>
                    <span asp-validation-for="DescripcionDetallada" class="text-danger"></span>
                </div>
            </div>

            <div class="form-group">
                <div class="col-md-offset-3 col-md-9">
                    <button type="submit" class="btn btn-primary">GUARDAR ESCENA</button>
                    <a asp-action="Index" class="btn btn-secondary">CANCELAR</a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Mostrar/ocultar campos de descripción según el checkbox
        document.addEventListener('DOMContentLoaded', function() {
            const checkboxes = document.querySelectorAll('.evidencia-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const evidenciaItem = this.closest('.evidencia-item');
                    const descripcionDiv = evidenciaItem.querySelector('.evidencia-descripcion');
                    const descripcionInput = evidenciaItem.querySelector('input[name="evidenciasDescripciones"]');
                    
                    if (this.checked) {
                        descripcionDiv.style.display = 'block';
                    } else {
                        descripcionDiv.style.display = 'none';
                        if (descripcionInput) {
                            descripcionInput.value = '';
                        }
                    }
                });
            });

            // Validación del formulario
            document.querySelector('form').addEventListener('submit', function(e) {
                const fechaCrimen = document.querySelector('input[name="FechaCrimen"]').value;
                const ubicacion = document.querySelector('input[name="Ubicacion"]').value;
                const tipoCrimenId = document.querySelector('select[name="TipoCrimenId"]').value;
                const modusOperandiId = document.querySelector('select[name="ModusOperandiId"]').value;
                const areaGeografica = document.querySelector('select[name="AreaGeografica"]').value;
                const horarioCrimen = document.querySelector('select[name="HorarioCrimen"]').value;

                if (!fechaCrimen || !ubicacion || !tipoCrimenId || !modusOperandiId || !areaGeografica || !horarioCrimen) {
                    e.preventDefault();
                    alert('Por favor, complete todos los campos obligatorios');
                    return false;
                }

                // Reorganizar las descripciones para que coincidan con el orden de las evidencias seleccionadas
                const descripcionesInputs = document.querySelectorAll('.evidencia-desc-input');
                const evidenciasSeleccionadas = [];
                const descripcionesSeleccionadas = [];
                
                checkboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        const evidenciaValue = checkbox.value;
                        evidenciasSeleccionadas.push(evidenciaValue);
                        
                        // Buscar la descripción correspondiente
                        const descripcionInput = checkbox.closest('.evidencia-item').querySelector('.evidencia-desc-input');
                        const descripcion = descripcionInput ? descripcionInput.value.trim() : '';
                        descripcionesSeleccionadas.push(descripcion);
                    }
                });
                
                // Limpiar todos los inputs de descripción no seleccionados
                descripcionesInputs.forEach(input => {
                    const checkbox = input.closest('.evidencia-item').querySelector('.evidencia-checkbox');
                    if (!checkbox.checked) {
                        input.disabled = true; // Deshabilitar para que no se envíe
                    }
                });
            });
        });
    </script>
}

<style>
    .form-container {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-top: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .form-header {
        background: #1a3a52;
        color: white;
        padding: 20px;
        border-bottom: 2px solid #2c5aa0;
    }

        .form-header h2 {
            margin: 0;
            font-size: 1.5em;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

    .form-body {
        padding: 30px;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .control-label {
        font-weight: 600;
        color: #333;
        letter-spacing: 0.2px;
    }

    .required {
        color: #cc3333;
    }

    .form-control {
        border: 1px solid #ccc;
        border-radius: 2px;
        padding: 10px;
        font-size: 0.95em;
    }

        .form-control:focus {
            border-color: #2c5aa0;
            box-shadow: inset 0 0 0 1px #2c5aa0;
            outline: none;
        }

    .evidencia-item {
        background-color: #f8f9fa;
        transition: background-color 0.2s;
    }

    .evidencia-item:hover {
        background-color: #e9ecef;
    }

    .evidencia-descripcion {
        margin-top: 10px;
    }

    .btn-primary {
        background-color: #1a3a52;
        border-color: #2c5aa0;
        color: white;
        padding: 10px 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

        .btn-primary:hover {
            background-color: #2c5aa0;
            border-color: #3a6bb5;
        }

    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
        color: white;
        padding: 10px 25px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        text-decoration: none;
        display: inline-block;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
            text-decoration: none;
            color: white;
        }

    .text-danger {
        color: #cc3333;
        font-size: 0.9em;
        margin-top: 5px;
        display: block;
    }

    .checkbox-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .checkbox-wrapper {
        display: flex;
        align-items: center;
    }
</style>